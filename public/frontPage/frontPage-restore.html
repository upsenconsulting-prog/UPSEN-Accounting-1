<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control - FactuFácil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #eef1f7; color: #333; }
    .sidebar { width: 250px; background: #2c3e50; color: white; min-height: 100vh; position: fixed; }
    .sidebar-header { padding: 20px; font-size: 1.4em; font-weight: bold; background: #1a252f; text-align: center; }
    .sidebar-menu { list-style: none; padding: 0; margin: 0; }
    .sidebar-menu li { padding: 15px 20px; cursor: pointer; }
    .sidebar-menu li:hover, .sidebar-menu li.active { background: #1abc9c; }
    .sidebar-link { color: inherit; text-decoration: none; display: block; }
    .main-content { margin-left: 250px; padding: 30px; }
    .page-title { font-size: 26px; font-weight: 700; color: #2c3e50; margin-bottom: 25px; }
    .card { background: white; border-radius: 12px; padding: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #2c3e50; }
    .summary-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; margin-bottom: 20px; }
    .summary-card h2 { font-size: 16px; color: #6c757d; margin-bottom: 10px; }
    .summary-card p { font-size: 24px; font-weight: bold; color: #2c3e50; }
    .btn { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
    .btn-primary { background-color: #2a4d9c; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
    th { background-color: #f8f9fa; font-weight: 600; }
    .chart-container { position: relative; height: 250px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">FactuFácil</div>
    <ul class="sidebar-menu">
      <li class="active"><a href="frontPage.html" class="sidebar-link">Panel de control</a></li>
      <li><a href="../expense/expense.html" class="sidebar-link">Gastos</a></li>
      <li><a href="../Invoice-issued/invoice-issued.html" class="sidebar-link">Facturas emitidas</a></li>
      <li><a href="../Invoice_recieved/Invoice_recieved.html" class="sidebar-link">Facturas recibidas</a></li>
      <li><a href="../budgetPage/budget.html" class="sidebar-link">Presupuestos</a></li>
    </ul>
  </aside>
  
  <main class="main-content">
    <h1 class="page-title">Panel de control</h1>
    
    <div class="row">
      <div class="col-md-3">
        <div class="summary-card">
          <h2>Facturas Recibidas</h2>
          <p><strong id="receivedTotal">EUR 0,00</strong></p>
          <small id="receivedCount">0 este mes</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <h2>Facturas Emitidas</h2>
          <p><strong id="issuedTotal">EUR 0,00</strong></p>
          <small id="issuedCount">0 este mes</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <h2>Gastos</h2>
          <p><strong id="expensesTotal">EUR 0,00</strong></p>
          <small id="expensesCount">0 este mes</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <h2>Presupuestos</h2>
          <p><strong id="budgetsTotal">EUR 0,00</strong></p>
          <small id="budgetsCount">0 total</small>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-header">Resumen de Gastos por Categoría</h2>
      <div class="chart-container">
        <canvas id="expensesChart"></canvas>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../shared/auth.js"></script>
  <script src="../shared/store.js"></script>
  <script>
    async function loadDashboard() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      
      const received = await window.sumInvoicesReceivedMonth(y, m);
      const receivedCount = await window.countInvoicesReceivedMonth(y, m);
      const issued = await window.sumInvoicesIssuedMonth(y, m);
      const issuedCount = await window.countInvoicesIssuedMonth(y, m);
      const expenses = await window.sumExpensesMonth(y, m);
      const expensesCount = await window.countExpensesMonth(y, m);
      const budgets = await window.getBudgets();
      const budgetsTotal = budgets.reduce((sum, b) => sum + (Number(b.total) || 0), 0);
      
      document.getElementById('receivedTotal').textContent = formatEUR(received);
      document.getElementById('receivedCount').textContent = receivedCount + ' este mes';
      document.getElementById('issuedTotal').textContent = formatEUR(issued);
      document.getElementById('issuedCount').textContent = issuedCount + ' este mes';
      document.getElementById('expensesTotal').textContent = formatEUR(expenses);
      document.getElementById('expensesCount').textContent = expensesCount + ' este mes';
      document.getElementById('budgetsTotal').textContent = formatEUR(budgetsTotal);
      document.getElementById('budgetsCount').textContent = budgets.length + ' total';
      
      const categories = await window.getExpensesByCategory(y, m);
      const ctx = document.getElementById('expensesChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(categories).length ? Object.keys(categories) : ['Sin datos'],
          datasets: [{
            data: Object.values(categories).length ? Object.values(categories) : [1],
            backgroundColor: ['#2a4d9c', '#3a6cd6', '#1abc9c', '#e74c3c', '#f39c12']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
      });
    }
    
    function formatEUR(n) {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n || 0);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      AuthManager.init();
      if (!AuthManager.isLoggedIn()) {
        window.location.href = '../login.html';
        return;
      }
      loadDashboard();
      
      const currentPage = window.location.href;
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.parentElement.classList.remove('active');
        if (link.href === currentPage) link.parentElement.classList.add('active');
      });
    });
  </script>
</body>
</html>

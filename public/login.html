<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - UPSEN Accounting</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #2a4d9c 0%, #3a6cd6 50%, #1e3a8a 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-container { background: white; padding: 0; border-radius: 20px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.35); width: 100%; max-width: 480px; overflow: hidden; }
    .login-header { background: linear-gradient(135deg, #2a4d9c, #3a6cd6); padding: 35px 30px; text-align: center; color: white; }
    .login-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .login-header p { font-size: 14px; opacity: 0.9; }
    .login-header i { font-size: 48px; margin-bottom: 15px; }
    .form-container { padding: 30px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 14px; }
    .form-group input { width: 100%; padding: 14px 16px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 15px; transition: all 0.3s; }
    .form-group input:focus { outline: none; border-color: #2a4d9c; box-shadow: 0 0 0 4px rgba(42, 77, 156, 0.1); }
    .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #2a4d9c, #3a6cd6); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(42, 77, 156, 0.4); }
    .login-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
    .google-btn { width: 100%; padding: 14px; background: white; color: #333; border: 2px solid #e9ecef; border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; }
    .google-btn:hover { border-color: #2a4d9c; background: #f8f9fa; }
    .divider { display: flex; align-items: center; margin: 25px 0; }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #e9ecef; }
    .divider span { padding: 0 15px; color: #6c757d; font-size: 13px; }
    .demo-accounts { margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; }
    .demo-accounts h6 { color: #495057; margin-bottom: 12px; font-size: 12px; text-transform: uppercase; }
    .demo-account { background: white; padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; display: flex; align-items: center; gap: 12px; }
    .demo-account:hover { border-color: #2a4d9c; transform: translateX(5px); }
    .demo-account i { color: #2a4d9c; font-size: 18px; width: 32px; height: 32px; background: rgba(42, 77, 156, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .demo-account strong { color: #2a4d9c; font-size: 14px; display: block; }
    .demo-account small { color: #6c757d; display: block; margin-top: 3px; font-size: 12px; }
    .alert { padding: 14px 16px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
    .alert-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .alert-success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
    .alert-info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
    .hidden { display: none !important; }
    .form-footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef; }
    .link-btn { background: none; border: none; color: #2a4d9c; font-weight: 500; cursor: pointer; padding: 0; font-size: 14px; text-decoration: underline; }
    .icon-margin { margin-right: 8px; }
    .password-requirements { font-size: 12px; color: #6c757d; margin-top: 5px; }
    .password-requirements li { margin-bottom: 3px; }
    .password-requirements .valid { color: #1abc9c; }
    .password-requirements .invalid { color: #e74c3c; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-header">
      <i class="fas fa-chart-line"></i>
      <h1>UPSEN Accounting</h1>
      <p>Sistema de Gestion Financiera</p>
    </div>
    <div class="form-container">
      <div id="message" class="alert alert-info">
        <i class="fas fa-info-circle"></i><span id="messageText">Sistema UPSEN - Inicia sesion para continuar</span>
      </div>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="email"><i class="fas fa-envelope icon-margin"></i>Correo electronico</label>
          <input type="email" id="email" placeholder="Tu correo electronico" required>
        </div>
        <div class="form-group">
          <label for="password"><i class="fas fa-lock icon-margin"></i>Contrasena</label>
          <input type="password" id="password" placeholder="Tu contrasena" required>
        </div>
        <button type="submit" class="login-btn" id="loginBtn"><i class="fas fa-sign-in-alt icon-margin"></i>Iniciar sesion</button>
        <button type="button" class="google-btn" onclick="tryGoogleLogin()"><i class="fab fa-google"></i>Continuar con Google</button>
        <div class="form-footer">
          <p>No tienes cuenta? <button type="button" class="link-btn" onclick="showRegister()">Crear cuenta</button></p>
        </div>
      </form>
      
      <form id="registerForm" class="hidden">
        <div class="form-group">
          <label for="regName"><i class="fas fa-user icon-margin"></i>Nombre completo *</label>
          <input type="text" id="regName" placeholder="Tu nombre completo" required>
        </div>
        <div class="form-group">
          <label for="regCompany"><i class="fas fa-building icon-margin"></i>Empresa *</label>
          <input type="text" id="regCompany" placeholder="Nombre de la empresa" required>
        </div>
        <div class="form-group">
          <label for="regEmail"><i class="fas fa-envelope icon-margin"></i>Correo electronico *</label>
          <input type="email" id="regEmail" placeholder="nombre@ejemplo.com" required>
        </div>
        <div class="form-group">
          <label for="regPhone"><i class="fas fa-phone icon-margin"></i>Telefono</label>
          <input type="tel" id="regPhone" placeholder="Tu telefono (opcional)">
        </div>
        <div class="form-group">
          <label for="regPassword"><i class="fas fa-lock icon-margin"></i>Contrasena *</label>
          <input type="password" id="regPassword" placeholder="Minimo 8 caracteres" required minlength="8">
          <ul class="password-requirements" id="passwordRequirements">
            <li id="req-length"><i class="fas fa-circle"></i> Minimo 8 caracteres</li>
            <li id="req-upper"><i class="fas fa-circle"></i> Una letra mayuscula</li>
            <li id="req-lower"><i class="fas fa-circle"></i> Una letra minuscula</li>
            <li id="req-number"><i class="fas fa-circle"></i> Un numero</li>
          </ul>
        </div>
        <div class="form-group">
          <label for="regPasswordConfirm"><i class="fas fa-lock icon-margin"></i>Confirmar contrasena *</label>
          <input type="password" id="regPasswordConfirm" placeholder="Repetir contrasena" required>
        </div>
        <button type="submit" class="login-btn" id="registerBtn"><i class="fas fa-user-plus icon-margin"></i>Crear cuenta</button>
        <div class="form-footer">
          <p>Ya tienes cuenta? <button type="button" class="link-btn" onclick="showLogin()">Iniciar sesion</button></p>
        </div>
      </form>
      
      <div id="demoSection">
        <div class="divider"><span>o probar</span></div>
        <div class="demo-accounts">
          <h6><i class="fas fa-flask icon-margin"></i>Cuentas demo</h6>
          <div class="demo-account" onclick="fillDemoLogin('admin@demo.com', 'demo123')">
            <i class="fas fa-user-shield"></i>
            <div><strong>Administrador</strong><small>admin@demo.com / demo123</small></div>
          </div>
          <div class="demo-account" onclick="fillDemoLogin('test@example.com', '123456')">
            <i class="fas fa-user"></i>
            <div><strong>Usuario Prueba</strong><small>test@example.com / 123456</small></div>
          </div>
        </div>
      </div>
    </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="shared/firebase-config.js"></script>
  <script src="shared/auth-system.js"></script>

  <script>
    var loginForm = document.getElementById('loginForm');
    var registerForm = document.getElementById('registerForm');
    var demoSection = document.getElementById('demoSection');
    var messageDiv = document.getElementById('message');
    var messageText = document.getElementById('messageText');
    var loginBtn = document.getElementById('loginBtn');
    var registerBtn = document.getElementById('registerBtn');
    
    // Email validation regex - enhanced version
    function isValidEmail(email) {
      if (!email || email.trim() === '') {
        return { valid: false, message: 'O campo email não pode estar vazio.' };
      }
      
      // Basic format check
      var emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailRegex.test(email)) {
        return { valid: false, message: 'Formato de email inválido. Use o formato: nome@exemplo.com' };
      }
      
      // Check for minimum domain length (must have at least one dot)
      var domain = email.split('@')[1];
      if (!domain || domain.indexOf('.') === -1) {
        return { valid: false, message: 'O domínio do email deve ser válido (ex: .com, .pt, .org)' };
      }
      
      // Check for valid characters (no spaces, no consecutive dots)
      if (email.includes(' ') || email.includes('..')) {
        return { valid: false, message: 'Email contém caracteres inválidos.' };
      }
      
      // Check email length limits
      if (email.length > 254) {
        return { valid: false, message: 'Email demasiado longo.' };
      }
      
      // Check local part (before @) - cannot start or end with certain characters
      var localPart = email.split('@')[0];
      if (localPart && (localPart.startsWith('.') || localPart.endsWith('.') || localPart.startsWith('-') || localPart.endsWith('-'))) {
        return { valid: false, message: 'O email não pode começar ou terminar com caracteres especiais.' };
      }
      
      return { valid: true, message: 'Email válido.' };
    }
    
    // Password strength validation
    function validatePassword(password) {
      var requirements = {
        length: password.length >= 8,
        upper: /[A-Z]/.test(password),
        lower: /[a-z]/.test(password),
        number: /[0-9]/.test(password)
      };
      return requirements;
    }
    
    // Update password requirement indicators
    function updatePasswordIndicators(password) {
      var reqs = validatePassword(password);
      
      var reqLength = document.getElementById('req-length');
      var reqUpper = document.getElementById('req-upper');
      var reqLower = document.getElementById('req-lower');
      var reqNumber = document.getElementById('req-number');
      
      if (reqLength) {
        reqLength.className = reqs.length ? 'valid' : 'invalid';
        reqLength.querySelector('i').className = reqs.length ? 'fas fa-check-circle' : 'fas fa-circle';
      }
      if (reqUpper) {
        reqUpper.className = reqs.upper ? 'valid' : 'invalid';
        reqUpper.querySelector('i').className = reqs.upper ? 'fas fa-check-circle' : 'fas fa-circle';
      }
      if (reqLower) {
        reqLower.className = reqs.lower ? 'valid' : 'invalid';
        reqLower.querySelector('i').className = reqs.lower ? 'fas fa-check-circle' : 'fas fa-circle';
      }
      if (reqNumber) {
        reqNumber.className = reqs.number ? 'valid' : 'invalid';
        reqNumber.querySelector('i').className = reqs.number ? 'fas fa-check-circle' : 'fas fa-circle';
      }
      
      return reqs.length && reqs.upper && reqs.lower && reqs.number;
    }
    
    function showMessage(text, type) {
      messageText.textContent = text;
      messageDiv.className = 'alert alert-' + (type || 'info');
    }
    
    function showLogin() {
      loginForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
      demoSection.classList.remove('hidden');
      showMessage('Sistema UPSEN - Inicia sesion para continuar', 'info');
    }
    
    function showRegister() {
      loginForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
      demoSection.classList.add('hidden');
      showMessage('Crea tu cuenta para empezar', 'info');
    }
    
    function fillDemoLogin(email, password) {
      document.getElementById('email').value = email;
      document.getElementById('password').value = password;
      showMessage('Credenciales preenchidas. Clica en Iniciar sesion.', 'info');
    }
    
    function redirectToDashboard() {
      window.location.href = 'frontPage/frontPage.html';
    }
    
    function tryGoogleLogin() {
      showMessage('Iniciando sesion con Google...', 'info');
      AuthService.loginWithGoogle().then(function(result) {
        if (result.success) {
          showMessage('Bienvenido!', 'success');
          setTimeout(redirectToDashboard, 1000);
        } else {
          showMessage(result.message, 'error');
        }
      });
    }
    
    // Add password strength listener
    var regPasswordInput = document.getElementById('regPassword');
    if (regPasswordInput) {
      regPasswordInput.addEventListener('input', function() {
        updatePasswordIndicators(this.value);
      });
    }
    
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var email = document.getElementById('email').value.trim();
      var password = document.getElementById('password').value;
      
      if (!email || !password) {
        showMessage('Por favor, completa todos los campos.', 'error');
        return;
      }
      
      var emailValidation = isValidEmail(email);
      if (!emailValidation.valid) {
        showMessage(emailValidation.message, 'error');
        return;
      }
      
      loginBtn.disabled = true;
      showMessage('Iniciando sesion...', 'info');
      
      AuthService.login(email, password).then(function(result) {
        loginBtn.disabled = false;
        
        if (result.success) {
          showMessage('Bienvenido!', 'success');
          setTimeout(redirectToDashboard, 1000);
        } else {
          showMessage(result.message, 'error');
        }
      });
    });
    
    registerForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var name = document.getElementById('regName').value.trim();
      var company = document.getElementById('regCompany').value.trim();
      var email = document.getElementById('regEmail').value.trim();
      var phone = document.getElementById('regPhone').value.trim();
      var password = document.getElementById('regPassword').value;
      var passwordConfirm = document.getElementById('regPasswordConfirm').value;
      
      if (!name || !company || !email || !password) {
        showMessage('Por favor, completa todos los campos obligatorios.', 'error');
        return;
      }
      
      var emailValidation = isValidEmail(email);
      if (!emailValidation.valid) {
        showMessage(emailValidation.message, 'error');
        return;
      }
      
      if (password !== passwordConfirm) {
        showMessage('Las contrasenas no coinciden.', 'error');
        return;
      }
      
      var passwordValid = validatePassword(password);
      if (!passwordValid.length || !passwordValid.upper || !passwordValid.lower || !passwordValid.number) {
        showMessage('La contrasena no cumple todos los requisitos.', 'error');
        return;
      }
      
      registerBtn.disabled = true;
      showMessage('Creando cuenta...', 'info');
      
      AuthService.register(email, password, { 
        name: name, 
        company: company,
        phone: phone 
      }).then(function(result) {
        registerBtn.disabled = false;
        
        if (result.success) {
          showMessage(result.message, 'success');
          // Clear form and switch to login after delay
          setTimeout(function() {
            registerForm.reset();
            // Reset password indicators
            updatePasswordIndicators('');
            showLogin();
          }, 3000);
        } else {
          showMessage(result.message, 'error');
        }
      });
    });
  </script>
</body>
</html>

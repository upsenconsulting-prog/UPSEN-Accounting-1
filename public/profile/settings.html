<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuracion - Accounting</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #eef1f7; min-height: 100vh; }
    .sidebar { width: 250px; background: #2c3e50; color: white; min-height: 100vh; position: fixed; }
    .sidebar-header { padding: 20px; font-size: 1.4em; font-weight: bold; background: #1a252f; text-align: center; }
    .sidebar-menu { list-style: none; padding: 0; margin: 0; }
    .sidebar-menu li { padding: 15px 20px; cursor: pointer; }
    .sidebar-menu li:hover { background: #1abc9c; }
    .sidebar-menu li.active { background: #1abc9c; }
    .sidebar-link { color: inherit; text-decoration: none; display: block; }
    .main-content { margin-left: 250px; padding: 30px; }
    .settings-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .section-title { color: #2a4d9c; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef; }
    .danger-zone { border: 1px solid #dc3545; background: #fff5f5; border-radius: 8px; padding: 20px; }
    .danger-title { color: #dc3545; font-weight: 600; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <aside class="sidebar">
      <div class="sidebar-header">Accounting</div>
      <ul class="sidebar-menu">
        <li><a href="../frontPage/frontPage.html" class="sidebar-link">Panel de control</a></li>
        <li><a href="../expense/expense.html" class="sidebar-link">Gastos</a></li>
        <li><a href="../Invoice-issued/invoice-issued.html" class="sidebar-link">Facturas emitidas</a></li>
        <li><a href="../Invoice_recieved/Invoice_recieved.html" class="sidebar-link">Facturas recibidas</a></li>
        <li><a href="../budgetPage/budget.html" class="sidebar-link">Presupuestos</a></li>
        <li><a href="../profile/profile.html" class="sidebar-link">Perfil</a></li>
        <li class="active"><a href="settings.html" class="sidebar-link">Configuracion</a></li>
      </ul>
    </aside>
    <main class="main-content col-md-9">
      <h1 class="mb-4">Configuracion</h1>
      <div class="settings-card">
        <h5 class="section-title">Datos de la Empresa</h5>
        <form id="profileForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombre de la Empresa</label>
              <input type="text" class="form-control" id="companyName">
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefono</label>
              <input type="text" class="form-control" id="phone">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </form>
      </div>
      <div class="settings-card">
        <h5 class="section-title">Cambiar Password</h5>
        <form id="passwordForm">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Password Actual</label>
              <input type="password" class="form-control" id="currentPassword">
            </div>
            <div class="col-md-4">
              <label class="form-label">Nueva Password</label>
              <input type="password" class="form-control" id="newPassword">
            </div>
            <div class="col-md-4">
              <label class="form-label">Confirmar Password</label>
              <input type="password" class="form-control" id="confirmPassword">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Cambiar password</button>
        </form>
      </div>
      <div class="settings-card">
        <h5 class="section-title">Preferencias</h5>
        <form id="settingsForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Moneda</label>
              <select class="form-select" id="currency">
                <option value="EUR">Euro (EUR)</option>
                <option value="USD">Dolar (USD)</option>
                <option value="GBP">Libra (GBP)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Idioma</label>
              <select class="form-select" id="language">
                <option value="es">Espanol</option>
                <option value="en">English</option>
                <option value="pt">Portugues</option>
              </select>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Guardar preferencias</button>
        </form>
      </div>
      <div class="settings-card">
        <h5 class="section-title">Mis Datos</h5>
        <button class="btn btn-success me-2" onclick="exportData()">Exportar datos</button>
        <button class="btn btn-secondary" onclick="downloadBackup()">Descargar backup</button>
      </div>
      <div class="settings-card danger-zone">
        <h5 class="danger-title">Zona de Peligro</h5>
        <p class="text-muted">Estas acciones son irreversibles.</p>
        <button class="btn btn-danger" onclick="deleteAccount()">Eliminar mi cuenta</button>
      </div>
    </main>
  </div>
</div>
<script src="../shared/auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  if (!AuthManager.isLoggedIn()) {
    window.location.href = '../frontPage/frontPage.html';
    return;
  }
  var user = AuthManager.getCurrentUser();
  document.getElementById('companyName').value = user.companyName || '';
  document.getElementById('phone').value = user.phone || '';
  document.getElementById('currency').value = user.settings?.currency || 'EUR';
  document.getElementById('language').value = user.settings?.language || 'es';
  
  document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var result = AuthManager.updateProfile({
      companyName: document.getElementById('companyName').value,
      phone: document.getElementById('phone').value
    });
    alert(result.success ? 'Perfil actualizado' : 'Error: ' + result.message);
  });
  
  document.getElementById('passwordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var current = document.getElementById('currentPassword').value;
    var newPass = document.getElementById('newPassword').value;
    var confirm = document.getElementById('confirmPassword').value;
    if (newPass !== confirm) { alert('Las passwords no coinciden'); return; }
    if (newPass.length < 6) { alert('Minimo 6 caracteres'); return; }
    var result = AuthManager.changePassword(current, newPass);
    alert(result.success ? 'Password actualizada' : 'Error: ' + result.message);
    if (result.success) document.getElementById('passwordForm').reset();
  });
  
  document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var result = AuthManager.updateProfile({
      settings: { currency: document.getElementById('currency').value, language: document.getElementById('language').value }
    });
    alert(result.success ? 'Preferencias guardadas' : 'Error: ' + result.message);
  });
});

function exportData() {
  var data = AuthManager.exportUserData();
  if (data) {
    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'accounting_backup.json';
    a.click();
  }
}

function downloadBackup() { exportData(); }

function deleteAccount() {
  if (confirm('Esta seguro de eliminar su cuenta? Todos los datos se perderan.')) {
    if (confirm('Esta accion no se puede deshacer.')) {
      AuthManager.deleteAccount();
    }
  }
}
</script>
</body>
</html>

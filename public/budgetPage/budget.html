<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presupuestos</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
/* Custom styles */
body {
  background-color: #f5f5f5;
}

.container {
  max-width: 1200px;
}

.mb-4.text-center {
  margin: 30px 0;
}

#budgetForm {
  background: white;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.1);
}

h1 {
  color: #2a4d9c;
  font-weight: 700;
}

h3 {
  color: #2c3e50;
  margin-top: 25px;
  margin-bottom: 15px;
}

.line-total {
  font-weight: bold;
  font-size: 1.1em;
}

#grandTotal {
  font-size: 1.5em;
  font-weight: bold;
  color: #2a4d9c;
  padding: 15px 0;
}

.form-label {
  font-weight: 500;
  color: #495057;
}

.table {
  margin-top: 15px;
}

.table th {
  background-color: #f8f9fa;
  font-weight: 600;
}

.btn {
  font-weight: 500;
}

.btn-primary {
  background-color: #2a4d9c;
  border-color: #2a4d9c;
}

.btn-primary:hover {
  background-color: #1e3a8a;
  border-color: #1e3a8a;
}

.btn-success {
  background-color: #198754;
  border-color: #198754;
}

/* Modal styles */
.modal {
  z-index: 9999;
}

.modal-content {
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}

.modal-header {
  background: linear-gradient(135deg, #2a4d9c, #3a6cd6);
  color: white;
}

.modal-header .modal-title {
  color: white;
  font-weight: 600;
}

.btn-close {
  filter: brightness(0) invert(1);
}

.table-dark th {
  background-color: #2a4d9c;
  color: white;
}
</style>
</head>
<body>

<div class="container my-5">
  <h1 class="text-center mb-4">Presupuestos</h1>
  
  <!-- Botones de acci√≥n -->
  <div class="mb-4 text-center">
    <button class="btn btn-primary me-2" id="newBudgetBtn">+ Nuevo presupuesto</button>
    <button class="btn btn-info text-white me-2" id="viewBudgetsBtn">Ver presupuestos</button>
    <a href="../frontPage/frontPage.html" class="btn btn-secondary">‚Üê Volver al panel</a>
  </div>
  
  <!-- Formulario de presupuesto -->
  <form id="budgetForm" class="card p-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">N√∫mero</label>
        <input type="text" id="number" class="form-control" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label">Serie</label>
        <select id="series" class="form-select">
          <option>Presupuestos</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Fecha</label>
        <input type="date" id="date" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Validez</label>
        <input type="date" id="validity" class="form-control">
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-4">
        <label class="form-label">Cliente *</label>
        <input type="text" id="customer" class="form-control" placeholder="Nombre del cliente">
      </div>
      <div class="col-md-4">
        <label class="form-label">Notas</label>
        <textarea id="notes" rows="3" class="form-control"></textarea>
      </div>
      <div class="col-md-4">
        <label class="form-label">Retenci√≥n</label>
        <select id="retention" class="form-select">
          <option>Sin retenci√≥n</option>
          <option>10%</option>
          <option>4%</option>
          <option>21%</option>
        </select>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-4">
        <label class="form-label">Estado</label>
        <select id="status" class="form-select">
          <option value="pending">Pendiente</option>
          <option value="approved">Aprobado</option>
          <option value="rejected">Rechazado</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Etiquetas</label>
        <input type="text" id="tags" class="form-control">
      </div>
    </div>

    <h3>üì¶ Art√≠culos</h3>
    <div class="table-responsive">
      <table class="table table-bordered" id="itemsTable">
        <thead>
          <tr>
            <th>Descripci√≥n</th>
            <th>Cantidad</th>
            <th>Coste (‚Ç¨)</th>
            <th>Total (‚Ç¨)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsTbody">
          <tr>
            <td><input type="text" class="form-control desc" placeholder="Art√≠culo"></td>
            <td><input type="number" class="form-control qty" value="1" min="1"></td>
            <td><input type="number" class="form-control unit" value="0" step="0.01"></td>
            <td class="line-total">0.00</td>
            <td><button type="button" class="btn btn-danger btn-sm remove-btn">X</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <button type="button" class="btn btn-primary mt-3" id="addItem">+ A√±adir art√≠culo</button>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <div id="grandTotal" class="text-end mt-3 fs-4 fw-bold" style="color: #2a4d9c;">Total: ‚Ç¨0.00</div>
      </div>
      <div class="col-md-6 text-end">
        <button type="button" class="btn btn-secondary me-2" id="cancelBtn">Cancelar</button>
        <button type="button" class="btn btn-success" id="saveBtn">üíæ Guardar presupuesto</button>
      </div>
    </div>
  </form>
</div>

<!-- Modal presupuestos guardados -->
<div class="modal fade" id="budgetsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìã Presupuestos guardados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>N√∫mero</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="budgetsTbody">
              <tr><td colspan="6" class="text-center">No hay presupuestos guardados</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal ver presupuesto -->
<div class="modal fade" id="viewBudgetModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìÑ Detalle del presupuesto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="viewBudgetContent"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../shared/auth.js"></script>
<script src="../shared/store.js"></script>
<script>
// Usar o sistema integrado do AuthManager e store.js
// As fun√ß√µes globais j√° est√£o dispon√≠veis: window.getBudgets(), window.addBudget(), etc.

function moneyEUR(n) {
  return '‚Ç¨' + (Number(n) || 0).toFixed(2);
}

function generateBudgetNumber() {
  const budgets = window.getBudgets();
  if (budgets.length === 0) {
    return 'BUD-001';
  }
  const maxNum = budgets.reduce((max, b) => {
    const num = parseInt((b.number || 'BUD-000').replace('BUD-', '')) || 0;
    return Math.max(max, num);
  }, 0);
  return 'BUD-' + String(maxNum + 1).padStart(3, '0');
}

// Update totals
function updateTotals() {
  const rows = document.querySelectorAll('#itemsTbody tr');
  let grandTotal = 0;
  
  rows.forEach(row => {
    const qty = parseFloat(row.querySelector('.qty')?.value) || 0;
    const unit = parseFloat(row.querySelector('.unit')?.value) || 0;
    const total = qty * unit;
    
    const lineTotal = row.querySelector('.line-total');
    if (lineTotal) {
      lineTotal.textContent = total.toFixed(2);
    }
    grandTotal += total;
  });
  
  const grandTotalEl = document.getElementById('grandTotal');
  if (grandTotalEl) {
    grandTotalEl.textContent = 'Total: ' + moneyEUR(grandTotal);
  }
  return grandTotal;
}

// Add new item row
function addNewItem() {
  const tbody = document.getElementById('itemsTbody');
  if (!tbody) return;
  
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td><input type="text" class="form-control desc" placeholder="Art√≠culo"></td>
    <td><input type="number" class="form-control qty" value="1" min="1"></td>
    <td><input type="number" class="form-control unit" value="0" step="0.01"></td>
    <td class="line-total">0.00</td>
    <td><button type="button" class="btn btn-danger btn-sm remove-btn">X</button></td>
  `;
  tbody.appendChild(newRow);
}

// Clear form
function clearForm() {
  document.getElementById('number').value = generateBudgetNumber();
  document.getElementById('customer').value = '';
  document.getElementById('date').value = '';
  document.getElementById('validity').value = '';
  document.getElementById('notes').value = '';
  document.getElementById('tags').value = '';
  document.getElementById('status').value = 'pending';
  
  const tbody = document.getElementById('itemsTbody');
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td><input type="text" class="form-control desc" placeholder="Art√≠culo"></td>
        <td><input type="number" class="form-control qty" value="1" min="1"></td>
        <td><input type="number" class="form-control unit" value="0" step="0.01"></td>
        <td class="line-total">0.00</td>
        <td><button type="button" class="btn btn-danger btn-sm remove-btn">X</button></td>
      </tr>
    `;
  }
  updateTotals();
}

// Save budget
function saveBudget() {
  const rows = document.querySelectorAll('#itemsTbody tr');
  const items = [];
  
  rows.forEach(row => {
    const desc = row.querySelector('.desc')?.value || '';
    const qty = parseFloat(row.querySelector('.qty')?.value) || 0;
    const unit = parseFloat(row.querySelector('.unit')?.value) || 0;
    const total = qty * unit;
    
    if (desc.trim()) {
      items.push({ desc, qty, unit, total });
    }
  });
  
  const data = {
    number: document.getElementById('number')?.value || generateBudgetNumber(),
    date: document.getElementById('date')?.value || '',
    validity: document.getElementById('validity')?.value || '',
    customer: document.getElementById('customer')?.value || '',
    notes: document.getElementById('notes')?.value || '',
    retention: document.getElementById('retention')?.value || '',
    status: document.getElementById('status')?.value || 'pending',
    tags: document.getElementById('tags')?.value || '',
    items,
    total: updateTotals()
  };
  
  if (!data.date || !data.customer) {
    alert('Por favor complete: fecha y cliente.');
    return;
  }
  
  if (data.items.length === 0) {
    alert('Por favor a√±ada al menos un art√≠culo.');
    return;
  }
  
  window.addBudget(data);
  alert('Presupuesto guardado correctamente!');
  clearForm();
}

// Modal instances
let budgetsModal = null;
let viewBudgetModal = null;

// Load saved budgets
function loadSavedBudgets() {
  const tbody = document.getElementById('budgetsTbody');
  if (!tbody) return;
  
  const budgets = window.getBudgets();
  
  if (budgets.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay presupuestos guardados</td></tr>';
    return;
  }
  
  const sorted = budgets.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
  
  tbody.innerHTML = sorted.map(budget => {
    const statusLabel = {
      'pending': 'Pendiente',
      'approved': 'Aprobado',
      'rejected': 'Rechazado'
    }[budget.status] || 'Pendiente';
    
    return `
    <tr>
      <td><strong>${budget.number || '-'}</strong></td>
      <td>${budget.date || '-'}</td>
      <td>${budget.customer || '-'}</td>
      <td><strong>${moneyEUR(budget.total)}</strong></td>
      <td>${statusLabel}</td>
      <td>
        <button class="btn btn-primary btn-sm me-1 view-btn" data-id="${budget.id}">Ver</button>
        <button class="btn btn-danger btn-sm delete-btn" data-id="${budget.id}">X</button>
      </td>
    </tr>
  `}).join('');
  
  // Add event listeners
  tbody.querySelectorAll('.view-btn').forEach(btn => {
    btn.onclick = () => showViewBudget(btn.dataset.id);
  });
  
  tbody.querySelectorAll('.delete-btn').forEach(btn => {
    btn.onclick = () => deleteBudgetItem(btn.dataset.id);
  });
}

// Show view budget modal
function showViewBudget(id) {
  const budget = window.getBudgets().find(b => b.id === id);
  if (!budget) return;
  
  const itemsHtml = budget.items?.map(item => `
    <tr>
      <td>${item.desc || ''}</td>
      <td>${item.qty || 0}</td>
      <td>${moneyEUR(item.unit)}</td>
      <td>${moneyEUR(item.total)}</td>
    </tr>
  `).join('') || '<tr><td colspan="4" class="text-center">Sin art√≠culos</td></tr>';
  
  const statusLabel = {
    'pending': 'Pendiente',
    'approved': 'Aprobado',
    'rejected': 'Rechazado'
  }[budget.status] || 'Pendiente';
  
  const content = document.getElementById('viewBudgetContent');
  if (content) {
    content.innerHTML = `
      <div class="row mb-3">
        <div class="col-md-6"><strong>N√∫mero:</strong> ${budget.number || '-'}</div>
        <div class="col-md-6"><strong>Fecha:</strong> ${budget.date || '-'}</div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6"><strong>Cliente:</strong> ${budget.customer || '-'}</div>
        <div class="col-md-6"><strong>Total:</strong> <span class="fs-4 fw-bold">${moneyEUR(budget.total)}</span></div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6"><strong>Estado:</strong> ${statusLabel}</div>
      </div>
      ${budget.notes ? `<div class="mb-3"><strong>Notas:</strong> ${budget.notes}</div>` : ''}
      <h5 class="mt-4">Art√≠culos</h5>
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-secondary">
            <tr><th>Descripci√≥n</th><th>Cantidad</th><th>Coste</th><th>Total</th></tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
        </table>
      </div>
    `;
  }
  
  if (!viewBudgetModal) {
    viewBudgetModal = new bootstrap.Modal(document.getElementById('viewBudgetModal'));
  }
  viewBudgetModal.show();
}

// Delete budget item
function deleteBudgetItem(id) {
  const budget = window.getBudgets().find(b => b.id === id);
  if (budget && confirm('¬øEliminar presupuesto ' + budget.number + '?')) {
    window.deleteBudget(id);
    loadSavedBudgets();
  }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  // Set budget number
  document.getElementById('number').value = generateBudgetNumber();
  
  // Add item button
  document.getElementById('addItem').onclick = addNewItem;
  
  // Remove item button (event delegation)
  document.getElementById('itemsTbody').onclick = (e) => {
    if (e.target.classList.contains('remove-btn')) {
      const row = e.target.closest('tr');
      if (row && document.querySelectorAll('#itemsTbody tr').length > 1) {
        row.remove();
        updateTotals();
      }
    }
  };
  
  // Update totals on input change
  document.getElementById('itemsTbody').oninput = (e) => {
    if (e.target.classList.contains('qty') || e.target.classList.contains('unit')) {
      updateTotals();
    }
  };
  
  // New budget button
  document.getElementById('newBudgetBtn').onclick = () => {
    if (confirm('¬øCrear nuevo presupuesto? Se limpiar√° el formulario.')) {
      clearForm();
    }
  };
  
  // View budgets button
  document.getElementById('viewBudgetsBtn').onclick = () => {
    loadSavedBudgets();
    if (!budgetsModal) {
      budgetsModal = new bootstrap.Modal(document.getElementById('budgetsModal'));
    }
    budgetsModal.show();
  };
  
  // Save button
  document.getElementById('saveBtn').onclick = saveBudget;
  
  // Cancel button
  document.getElementById('cancelBtn').onclick = () => {
    if (confirm('¬øCancelar y limpiar el formulario?')) {
      clearForm();
    }
  };
  
  // Initial update
  updateTotals();
});
</script>
</body>
</html>

